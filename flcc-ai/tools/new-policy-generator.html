
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- FIX: Updated CSP to allow data images, Cloudflare beacon (to stop errors), and CDN scripts -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https://cdnjs.cloudflare.com https://static.cloudflareinsights.com blob: data:;
        style-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline';
        script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://static.cloudflareinsights.com;
        connect-src 'self' https://cloudflareinsights.com;
        img-src 'self' data: blob: https://cdnjs.cloudflare.com;
        frame-src https://www.youtube-nocookie.com 'self';
    ">
    
    <!-- FIX: Added Favicon to prevent 404 error -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
    
    <title>FLCC AI Policy Statement Generator</title>
    
    <!-- External Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- MERGED CSS START --- */
        :root {
            --primary-color: #0046ad;
            --secondary-color: #f5f5f5;
            --text-color: #333;
            --border-radius: 0.5rem;
            --spacing: 1rem;
            --column-gap: 1.5rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #fff;
            min-height: 100vh;
            width: 100%;
        }

        /* LAYOUT UPDATE: Flex column for the main container */
        .container {
            width: 100%;
            max-width: 87.5rem;
            margin: 0 auto;
            padding: var(--spacing);
            display: flex;
            flex-direction: column;
            /* Allow height to grow naturally on mobile, constrained on desktop */
        }

        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-size: clamp(1.25rem, 3vw, 2rem);
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        h2 {
            margin-bottom: 1rem;
            color: var(--text-color);
            font-size: clamp(1.1rem, 2.5vw, 1.5rem);
        }

        /* Form Container */
        .form-container {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: var(--column-gap);
            align-items: start;
            /* Default to normal flow */
        }

        /* Questions Column */
        .questions-column {
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        /* Preview Column */
        .preview-column {
            flex: 1;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-left: 1px solid #dee2e6;
            /* Removed overflow-y: auto here, handled in media query */
        }

        .preview-container {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        /* --- INDEPENDENT SCROLLING FOR DESKTOP --- */
        @media (min-width: 1025px) {
            body {
                height: 100vh; /* Lock body height */
                overflow: hidden; /* Prevent body scroll */
            }

            .container {
                height: 100%; /* Fill viewport */
            }

            .form-container {
                flex: 1; /* Take remaining height after header/footer */
                overflow: hidden; /* Contain children */
                height: 100%;
                align-items: stretch; /* Stretch columns to full height */
            }

            .questions-column, 
            .preview-column {
                height: 100%;
                overflow-y: auto; /* Independent scrolling */
                padding-bottom: 3rem; /* Extra space at bottom */
                scrollbar-width: thin; /* Firefox: make scrollbar thinner */
                scrollbar-color: #ccc transparent;
            }
            
            /* Webkit scrollbar styling */
            .questions-column::-webkit-scrollbar,
            .preview-column::-webkit-scrollbar {
                width: 8px;
            }
            .questions-column::-webkit-scrollbar-track,
            .preview-column::-webkit-scrollbar-track {
                background: transparent;
            }
            .questions-column::-webkit-scrollbar-thumb,
            .preview-column::-webkit-scrollbar-thumb {
                background-color: #ccc;
                border-radius: 4px;
            }
        }

        /* Form Styles */
        .policy-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
        }

        .question-container {
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            width: 100%;
        }

        .option-card {
            position: relative;
            cursor: pointer;
            width: 100%;
        }

        .option-card input[type="radio"],
        .option-card input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

        .card-content {
            padding: 1rem;
            background-color: var(--secondary-color);
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            width: 100%;
            height: 100%;
        }

        .option-card input[type="radio"]:checked + .card-content,
        .option-card input[type="checkbox"]:checked + .card-content {
            border-color: var(--primary-color);
            background-color: #e6f0ff;
        }

        .option-card:hover .card-content {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-content i {
            font-size: clamp(1.25rem, 2.5vw, 1.5rem);
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            display: block;
        }

        .card-content h3 {
            margin-bottom: 0.25rem;
            font-size: clamp(0.9rem, 1.75vw, 1.1rem);
        }

        .card-content p {
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
        }

        /* Policy Statement */
        .policy-statement {
            margin-bottom: 1.5rem;
        }

        .policy-statement .icon,
        .policy-list .icon {
            font-size: 1.5em !important;
            vertical-align: middle;
            margin-right: 0.25em;
        }

        .policy-section {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
            width: 100%;
        }

        .policy-section i {
            font-size: clamp(1.1rem, 1.75vw, 1.25rem);
            color: var(--primary-color);
            margin-top: 0.25rem;
            flex-shrink: 0;
        }

        .policy-section p {
            margin: 0;
            flex: 1;
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            width: 100%;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 100px;
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn:hover {
            background-color: #003a90;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Accessibility */
        .hidden {
            display: none !important;
        }

        /* Focus styles */
        :focus {
            outline: 3px solid #ffd700;
            outline-offset: 2px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .form-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .preview-column {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --primary-color: #0000ff;
                --text-color: #000;
                --secondary-color: #fff;
            }

            .card-content {
                border: 2px solid #000;
            }
        }

        /* Documentation Styles */
        .documentation-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            width: 100%;
        }

        .documentation-section {
            width: 100%;
        }

        .documentation-header {
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: clamp(0.9rem, 1.75vw, 1.1rem);
        }

        .documentation-requirements {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .requirement-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
        }

        .requirement-item i {
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-top: 0.25rem;
        }

        .requirement-item span {
            flex: 1;
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
        }

        /* Other Documentation Input */
        .other-documentation-container {
            grid-column: 1 / -1;
            margin-top: 0.75rem;
            width: 100%;
        }

        .other-documentation-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }

        .other-documentation-input label {
            font-weight: 500;
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
        }

        .other-documentation-input textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
            resize: vertical;
            min-height: 80px;
        }

        .other-documentation-input textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 70, 173, 0.2);
        }

        /* Citation Format Selector */
        .citation-format-container {
            margin: 0.5rem 0 0.75rem 1.5rem;
            padding: 0.75rem;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }

        .citation-format-container h3 {
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-size: clamp(0.9rem, 1.75vw, 1.1rem);
        }

        .citation-format-selector {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .citation-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
            background-color: white;
            cursor: pointer;
            width: 100%;
        }

        .citation-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 70, 173, 0.2);
        }

        .other-citation-format {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .other-citation-format label {
            font-weight: 500;
        }

        .other-citation-format input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
            width: 100%;
        }

        .other-citation-format input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 70, 173, 0.2);
        }

        /* Documentation Section Styles */
        .documentation-section {
            width: 100%;
        }

        .documentation-header {
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .documentation-requirements {
            margin-left: 2rem;
        }

        .requirement-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .requirement-item i {
            font-size: 1.25rem;
            color: var(--primary-color);
            margin-top: 0.25rem;
        }

        .requirement-item span {
            flex: 1;
        }

        /* Header Container */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-container h1 {
            margin-bottom: 0;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: #333;
        }

        .close-modal .icon {
            font-size: 1.5rem;
            font-weight: bold;
            color: inherit;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .code-container {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
            position: relative;
        }

        .code-container pre {
            margin: 0;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .code-container code {
            display: block;
            white-space: pre;
        }

        #copyEmbedBtn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .embed-preview {
            margin-top: 2rem;
        }

        .embed-preview h3 {
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .preview-frame {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        /* Responsive Modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 1rem;
            }

            .code-container pre {
                font-size: 0.75rem;
            }

            #copyEmbedBtn {
                position: static;
                width: 100%;
                margin-top: 1rem;
            }
        }

        /* Footer Styles */
        .app-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            flex-shrink: 0; /* Prevent footer shrink in flex container */
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .acknowledgement {
            flex: 1;
        }

        .acknowledgement p {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #666;
        }

        .acknowledgement a {
            color: var(--primary-color);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .acknowledgement a:hover {
            text-decoration: underline;
        }

        .acknowledgement i {
            font-size: 1.25rem;
        }

        /* Responsive Footer */
        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
        }

        .policy-header {
            background-color: #f8f9fa;
            border-left: 4px solid #0046ad;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            text-align: left;
        }

        .policy-header.policy-permitted {
            border-left-color: #58a618;
        }

        .policy-header.policy-limited {
            border-left-color: #ffc107;
        }

        .policy-header.policy-prohibited {
            border-left-color: #dc3545;
        }

        .policy-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: 600;
        }

        .policy-header i {
            color: #0046ad;
            margin-right: 0.5rem;
            font-size: 1.25rem;
        }

        .policy-icon {
            font-size: 2rem;
            margin-right: 0.5rem;
            display: inline-block;
            vertical-align: middle;
        }

        .policy-icon:last-child {
            margin-right: 0;
        }

        .policy-icons {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .policy-list {
            list-style: none;
            padding-left: 0;
        }

        /* Download Modal Styles */
        .download-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .download-option {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .download-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .download-option:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 70, 173, 0.1);
        }

        .option-icon {
            font-size: 2rem;
            flex-shrink: 0;
            width: 3rem;
            text-align: center;
        }

        .option-content h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .option-content p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Responsive Download Modal */
        @media (max-width: 768px) {
            .download-option {
                padding: 1rem;
            }
            
            .option-icon {
                font-size: 1.5rem;
                width: 2.5rem;
            }
            
            .option-content h3 {
                font-size: 1rem;
            }
            
            .option-content p {
                font-size: 0.85rem;
            }
        }
        
        /* New Styles from policy.html head */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.2s ease-in-out;
        }
        .skip-link:focus {
            top: 0;
        }

        /* Focus styles for all interactive elements */
        a:focus,
        button:focus,
        input:focus,
        textarea:focus,
        select:focus,
        [role="button"]:focus {
            outline: 3px solid #0046ad;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 70, 173, 0.25);
        }

        /* Remove default focus outline and add custom one */
        *:focus {
            outline: none;
        }

        /* Ensure focus is visible even when using mouse */
        *:focus-visible {
            outline: 3px solid #0046ad;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 70, 173, 0.25);
        }

        /* Custom focus styles for radio and checkbox inputs */
        input[type="radio"]:focus,
        input[type="checkbox"]:focus {
            outline: 3px solid #0046ad;
            outline-offset: 2px;
        }

        /* Ensure focus is visible on the option cards */
        .option-card:focus-within {
            outline: 3px solid #0046ad;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 70, 173, 0.25);
        }

        .icon {
            font-size: 1.5em;
            vertical-align: middle;
            margin-right: 0.5em;
        }

        /* Alt Text Container Styles */
        .alt-text-container {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #ddd;
        }
        
        .alt-text-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .alt-text-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #666;
        }
        
        .alt-text-area {
            width: 100%;
            height: 100px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 0.5rem;
        }
        
        .alt-text-area:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 70, 173, 0.2);
        }
        
        .copy-alt-btn {
            background-color: transparent;
            border: 1px solid #ddd;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            color: #666;
            transition: all 0.2s;
        }
        
        .copy-alt-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        /* Grayed-out card state (when an exclusive option is selected) */
        .option-card.grayed-out {
            cursor: not-allowed;
        }
        .option-card.grayed-out .card-content {
            opacity: 0.35;
            pointer-events: none;
        }
        /* Prohibition reason container */
        #prohibitionReasonContainer {
            padding: 1rem;
            background: #fff8f8;
            border: 1px solid #f5c6cb;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }
        #prohibitionReasonContainer label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        #prohibitionReasonText {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: clamp(0.8rem, 1.25vw, 0.9rem);
            resize: vertical;
            min-height: 60px;
            margin-top: 0.5rem;
        }
        /* Use case title/text inside policy preview list items */
        h4.use-case-title {
            font-size: 1rem;
            font-weight: bold;
            margin: 0;
        }
        p.use-case-text {
            font-size: 0.9rem;
            margin: 0.1rem 0 0;
            color: #555;
        }
        /* Flex row: emoji + h4 on the same line in preview items */
        .use-case-header {
            display: flex;
            align-items: center;
            gap: 0.3em;
            margin-bottom: 0.2rem;
        }
        .use-case-header .icon {
            margin-right: 0;
            flex-shrink: 0;
            font-size: 1.2em;
        }

        /* h3 documentation-header reset (browser adds margin to h3 by default) */
        h3.documentation-header {
            margin-top: 0;
            font-size: clamp(0.9rem, 1.75vw, 1.1rem);
            font-weight: bold;
        }

        /* Center emoji in concept cards (above the title) */
        .card-content .icon {
            display: block;
            text-align: center;
            margin-right: 0;
            margin-bottom: 0.5rem;
        }

        /* Code elements in card descriptions */
        .card-content code {
            font-family: monospace;
            font-size: 0.85em;
            background: #f0f4ff;
            border: 1px solid #c0d0ee;
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Modal action row (Done/Cancel buttons) */
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        /* YouTube embed ‚Äî responsive 16:9 */
        .info-video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            background: #000;
        }
        .info-video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .info-text p {
            margin-bottom: 1rem;
            line-height: 1.7;
            color: #444;
        }

        /* FA icon spacing inside buttons */
        .btn i, .copy-alt-btn i {
            margin-right: 0.35em;
        }

        /* Share modal section heading */
        .share-section-heading {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            margin: 1rem 0 0.5rem;
        }
        .share-section-heading:first-child {
            margin-top: 0;
        }
        /* --- MERGED CSS END --- */
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <main id="main-content" class="container" role="main" tabindex="-1">
        <h1>FLCC AI Policy Statement Generator</h1>
        
        <div class="form-container">
            <!-- Left Column: Questions -->
            <div class="questions-column" role="region" aria-label="Policy Configuration">
                <form id="policyForm" class="policy-form" aria-label="AI Policy Configuration Form">
                    <!-- Question 1: AI Use Cases (Prohibited & Open Use are exclusive options at top) -->
                    <div class="question-container" id="question5" data-question="useCases" role="group" aria-labelledby="use-cases-heading">
                        <h2 id="use-cases-heading">How may learners use AI in this assignment?</h2>
                        <div class="options-grid" role="group" aria-labelledby="use-cases-heading">
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="prohibited" aria-describedby="prohibited-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üö´</span>
                                    <h3>No AI Use</h3>
                                    <p id="prohibited-desc">This assignment is designed to be completed without AI tools.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="encouraged" aria-describedby="encouraged-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">‚úÖ</span>
                                    <h3>Open Use</h3>
                                    <p id="encouraged-desc">You are welcome to explore AI tools freely throughout this assignment.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="brainstorming" aria-describedby="brainstorming-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üí°</span>
                                    <h3>Brainstorming</h3>
                                    <p id="brainstorming-desc">AI can help you peek over the hill and surface ideas you might not have considered - giving you more raw material to evaluate, discard, or build on.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="research" aria-describedby="research-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üîç</span>
                                    <h3>Research and Summarization</h3>
                                    <p id="research-desc">Use AI to quickly surface key themes and condense large amounts of information, freeing you to focus on analysis and critical thinking rather than just collecting facts.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="outline" aria-describedby="outline-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üóíÔ∏è</span>
                                    <h3>Outline and Thesis</h3>
                                    <p id="outline-desc">Test-drive different organizational structures and thesis angles with AI, then choose and refine the one that best serves your argument.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="content" aria-describedby="content-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üìù</span>
                                    <h3>Content Generation</h3>
                                    <p id="content-desc">AI-generated drafts give you something concrete to react to and revise - often a faster path to finding your own voice than staring at a blank page.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="critique" aria-describedby="critique-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üó®Ô∏è</span>
                                    <h3>Critique and Peer Review</h3>
                                    <p id="critique-desc">AI can spot gaps in logic, unclear phrasing, or missing evidence - acting like a tireless first reader before you share your work with others.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="analysis" aria-describedby="analysis-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üìä</span>
                                    <h3>Data Analysis</h3>
                                    <p id="analysis-desc">AI can help you spot patterns and surface questions in complex datasets, so you can spend more time interpreting what the data actually means.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="useCases" value="other" aria-describedby="other-use-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">‚ûï</span>
                                    <h3>Other Use Cases</h3>
                                    <p id="other-use-desc">Have something else in mind? Describe it below.</p>
                                </div>
                            </label>
                            <div id="otherUseCasesContainer" class="other-documentation-container hidden" role="group" aria-labelledby="custom-use-label">
                                <div class="other-documentation-input">
                                    <label id="custom-use-label" for="customUseCases">Specify other use cases:</label>
                                    <textarea id="customUseCases" name="customUseCases" placeholder="Enter additional approved use cases" rows="3" aria-labelledby="custom-use-label"></textarea>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Question 2: Documentation Requirements -->
                    <div class="question-container" id="question4" data-question="documentation" role="group" aria-labelledby="documentation-heading">
                        <h2 id="documentation-heading">What should learners include when submitting AI-assisted work?</h2>
                        <div class="options-grid documentation-options" role="group" aria-labelledby="documentation-heading">
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="none" aria-describedby="none-doc-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">‚ùå</span>
                                    <h3>No Disclosure Required</h3>
                                    <p id="none-doc-desc">Learners are not required to disclose or document their use of AI for this assignment. AI use is fully permitted - keep the focus on the task itself.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="tools" aria-describedby="tools-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üìù</span>
                                    <h3>Document Platforms</h3>
                                    <p id="tools-desc">Please document which AI platforms and tools you used. Be intentional about tool choice, and help me understand the AI landscape you find valuable.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="chatsummary" aria-describedby="chatsummary-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üí¨</span>
                                    <h3>Submit Chat Summary</h3>
                                    <p id="chatsummary-desc">Include a brief AI-generated overview of your conversation. Try this prompt: <code>Please summarize the chat we've just had into 2 or 3 paragraphs.</code></p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="prompts" aria-describedby="prompts-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üì§</span>
                                    <h3>Submit Prompts & Outputs</h3>
                                    <p id="prompts-desc">Please include your prompts and AI outputs with your submission. This makes visible how you shape questions and evaluate responses - skills that are as important as the output itself.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="citation" aria-describedby="citation-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üßæ</span>
                                    <h3>Formal Citation Required</h3>
                                    <p id="citation-desc">Please include formal citations for any AI-generated content you use. Reinforces information literacy: provenance matters regardless of source, and AI-generated content deserves the same scrutiny as any other reference.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="reflection" aria-describedby="reflection-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üß†</span>
                                    <h3>Additional Reflection</h3>
                                    <p id="reflection-desc">Please include a brief reflection on your AI usage and what you learned from the experience. Metacognitive writing strengthens ownership of the final work by helping you articulate what you changed, what you kept, and why.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="factcheck" aria-describedby="factcheck-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üîé</span>
                                    <h3>Fact Check</h3>
                                    <p id="factcheck-desc">Please verify AI-generated information against trusted sources and document your fact-checking process. AI can confidently produce inaccurate information. Requiring verification reinforces that accuracy is your responsibility, not the tool's.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="multitools" aria-describedby="multitools-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">üîÑ</span>
                                    <h3>Compare Multiple Tools</h3>
                                    <p id="multitools-desc">Please compare results from at least two AI tools and reflect on the differences. Seeing that responses vary across tools builds critical perspective and helps you resist treating any single AI answer as authoritative.</p>
                                </div>
                            </label>
                            <label class="option-card checkbox-card">
                                <input type="checkbox" name="documentation" value="other" aria-describedby="other-desc">
                                <div class="card-content">
                                    <span aria-hidden="true" class="icon">‚ûï</span>
                                    <h3>Other Requirements</h3>
                                    <p id="other-desc">Have additional documentation requirements? Specify them below.</p>
                                </div>
                            </label>
                            <div id="otherDocumentationContainer" class="other-documentation-container hidden" role="group" aria-labelledby="custom-doc-label">
                                <div class="other-documentation-input">
                                    <label id="custom-doc-label" for="customDocumentation">Specify additional requirements:</label>
                                    <textarea id="customDocumentation" name="customDocumentation" placeholder="Enter your additional documentation or assignment requirements" rows="3" aria-labelledby="custom-doc-label"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Right Column: Policy Preview -->
            <div class="preview-column" role="region" aria-label="Policy Preview">
                <div class="preview-container">
                    <h2>Policy Preview</h2>
                    <div id="previewContainer" class="policy-statement" role="region" aria-live="polite">
                        <!-- Policy statement will be generated here -->
                    </div>
                    <div class="action-buttons">
                        <button type="button" id="infoBtn" class="btn btn-secondary" aria-label="About this tool"><i class="fas fa-circle-info" aria-hidden="true"></i> Info</button>
                        <button type="button" id="startOverBtn" class="btn btn-secondary" aria-label="Start over and clear all selections"><i class="fas fa-rotate-left" aria-hidden="true"></i> Restart</button>
                        <button type="button" id="shareBtn" class="btn" aria-label="Share or download policy"><i class="fas fa-share-nodes" aria-hidden="true"></i> Share</button>
                        <button type="button" id="embedBtn" class="btn" aria-label="Open embed code modal"><i class="fas fa-code" aria-hidden="true"></i> Embed</button>
                    </div>
                    
                    <!-- New Alt Text Container -->
                    <div class="alt-text-container">
                        <div class="alt-text-header">
                            <h3>Alt Text for Accessibility</h3>
                            <button type="button" id="copyAltBtn" class="copy-alt-btn" aria-label="Copy Alt Text to clipboard">
                                <i class="fas fa-copy" aria-hidden="true"></i> Copy
                            </button>
                        </div>
                        <textarea id="altTextArea" class="alt-text-area" readonly aria-label="Alt Text Representation of the Policy"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <footer class="app-footer">
            <div class="footer-content">
                <div class="acknowledgement">
                    <p>This AI Policy Generator was built on the original work created by Ed Beck and Tera Doty-Blance and has been shared under a <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">Creative Commons Attribution 4.0 International License <i class="fab fa-creative-commons" aria-hidden="true"></i> <i class="fab fa-creative-commons-by" aria-hidden="true"></i></a>.</p>
                    <p>Source code is available on <a href="https://github.com/corydave/websitetest/tree/main/claude/aiPolicyGenerator" target="_blank">GitHub <i class="fab fa-github" aria-hidden="true"></i></a> and was forked from <a href="https://github.com/beckej13820/edu-apps" target="_blank" rel="noopener noreferrer">Ed Beck's pioneering work.</a></p>
                </div>
            </div>
        </footer>
    </main>

    <!-- No AI Use ‚Äî Reason Modal -->
    <div id="noAiModal" class="modal hidden" role="dialog" aria-labelledby="no-ai-modal-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="no-ai-modal-title">Why is AI not permitted?</h2>
                <button class="no-ai-cancel" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;padding:0.5rem;line-height:1;" aria-label="Cancel and uncheck No AI Use">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color:#666;margin-bottom:1rem;font-size:0.9rem;">Optional ‚Äî but a brief explanation helps learners understand your reasoning.</p>
                <div id="prohibitionReasonContainer">
                    <div class="options-grid" style="margin-bottom:0.75rem;">
                        <label class="option-card">
                            <input type="radio" name="prohibitionReason" value="Learners should demonstrate their own knowledge and skills without AI assistance.">
                            <div class="card-content">
                                <h3>Demonstrate Own Skills</h3>
                                <p>Learners should demonstrate their own knowledge and skills without AI assistance.</p>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="prohibitionReason" value="This is an in-class or timed assessment where AI tools are not available.">
                            <div class="card-content">
                                <h3>In-Class Assessment</h3>
                                <p>This is an in-class or timed assessment where AI tools are not available.</p>
                            </div>
                        </label>
                        <label class="option-card">
                            <input type="radio" name="prohibitionReason" value="The learning objectives for this assignment require learners to develop their own original ideas.">
                            <div class="card-content">
                                <h3>Original Thinking Required</h3>
                                <p>The learning objectives require learners to develop their own original ideas.</p>
                            </div>
                        </label>
                    </div>
                    <textarea id="prohibitionReasonText" name="prohibitionReasonText" placeholder="Or write your own explanation for learners‚Ä¶" style="width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:var(--border-radius);font-size:clamp(0.8rem,1.25vw,0.9rem);resize:vertical;min-height:60px;margin-top:0.5rem;"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="noAiCancelBtn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="noAiDoneBtn" class="btn">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal hidden" role="dialog" aria-labelledby="info-modal-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="info-modal-title">About This Tool</h2>
                <button class="close-modal" aria-label="Close modal">
                    <span class="icon" aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="info-video-container">
                    <iframe
                        src="https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ"
                        title="About the AI Policy Generator"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>
                <div class="info-text">
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                    <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    <p>Sed ut perspiciatis, unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam eaque ipsa, quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt, explicabo.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Embed Modal -->
    <div id="embedModal" class="modal hidden" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Embed AI Policy Generator</h2>
                <button class="close-modal" aria-label="Close modal">
                    <span class="icon" aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Copy and paste this code to embed the AI Policy Generator on your website or LMS:</p>
                <div class="code-container">
                    <pre><code id="embedCode"></code></pre>
                    <button id="copyEmbedBtn" class="btn" aria-label="Copy embed code to clipboard">
                        <span class="icon" aria-hidden="true">üìã</span> Copy Code
                    </button>
                </div>
                
                <div class="embed-preview">
                    <h3>Preview:</h3>
                    <div class="preview-frame">
                        <iframe 
                            src="index.html" 
                            style="width: 100%; border: none; min-height: 400px;"
                            title="AI Policy Generator Preview"
                            allow="clipboard-write"
                            aria-label="Preview of the AI Policy Generator"
                        ></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share & Download Modal -->
    <div id="downloadModal" class="modal hidden" role="dialog" aria-labelledby="download-modal-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="download-modal-title">Share & Download</h2>
                <button class="close-modal" aria-label="Close modal">
                    <span class="icon" aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="share-section-heading">Share</p>
                <div class="download-options" style="margin-bottom: 1rem;">
                    <button id="copyUrlBtn" class="download-option">
                        <div class="option-icon">üîó</div>
                        <div class="option-content">
                            <h3>Copy URL</h3>
                            <p>Copy a shareable link that restores this exact policy configuration.</p>
                        </div>
                    </button>
                </div>
                <p class="share-section-heading">Download</p>
                <div class="download-options" id="downloadOptionsGrid">
                    <button id="downloadHTML" class="download-option">
                        <div class="option-icon">üåê</div>
                        <div class="option-content">
                            <h3>HTML Document</h3>
                            <p>Formatted web page with icons and styling. Opens in any browser and can be printed or saved as PDF.</p>
                        </div>
                    </button>
                    <button id="downloadMarkdown" class="download-option">
                        <div class="option-icon">üìù</div>
                        <div class="option-content">
                            <h3>Markdown</h3>
                            <p>Plain text format with simple formatting. Works well with platforms like GitHub, Notion, and many editors.</p>
                        </div>
                    </button>
                    <button id="downloadText" class="download-option">
                        <div class="option-icon">üìÑ</div>
                        <div class="option-content">
                            <h3>Plain Text</h3>
                            <p>Simple text format that works everywhere. Icons will appear as emoji characters.</p>
                        </div>
                    </button>
                    <button id="downloadPNG" class="download-option">
                        <div class="option-icon">üñºÔ∏è</div>
                        <div class="option-content">
                            <h3>PNG Image</h3>
                            <p>Image format suitable for slides or documents. Captures the preview box.</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADDED: PNG Reminder Modal -->
    <div id="pngReminderModal" class="modal hidden" role="dialog" aria-labelledby="png-reminder-title" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="png-reminder-title">Important: Accessibility</h2>
                <button class="close-modal" aria-label="Close modal">
                    <span class="icon" aria-hidden="true">√ó</span>
                </button>
            </div>
            <div class="modal-body">
                <p>You have successfully downloaded the PNG image.</p>
                <p style="margin-top: 1rem;"><strong>Please ensure you copy the Alt Text below</strong> to provide accessible text for screen readers wherever you upload this image.</p>
                
                <div class="alt-text-container" style="border: none; margin-top: 1rem; padding-top: 0;">
                    <textarea id="modalAltTextArea" class="alt-text-area" readonly aria-label="Alt Text Representation of the Policy"></textarea>
                    <button type="button" id="modalCopyAltBtn" class="btn" style="margin-top: 0.5rem; width: 100%;">
                        <span class="icon" aria-hidden="true">üìã</span> Copy Alt Text
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- MERGED JS START --- */
        document.addEventListener('DOMContentLoaded', function() {

            const form = document.getElementById('policyForm');
            const previewContainer = document.getElementById('previewContainer');
            const startOverBtn = document.getElementById('startOverBtn');
            const shareBtn = document.getElementById('shareBtn');
            const infoBtn = document.getElementById('infoBtn');
            const otherDocumentationContainer = document.getElementById('otherDocumentationContainer');

            // Alt Text Elements
            const altTextArea = document.getElementById('altTextArea');
            const copyAltBtn = document.getElementById('copyAltBtn');

            // PNG Modal Elements
            const pngReminderModal = document.getElementById('pngReminderModal');
            const modalAltTextArea = document.getElementById('modalAltTextArea');
            const modalCopyAltBtn = document.getElementById('modalCopyAltBtn');

            // Embed Modal Elements
            const embedBtn = document.getElementById('embedBtn');
            const embedModal = document.getElementById('embedModal');
            const embedCode = document.getElementById('embedCode');
            const copyEmbedBtn = document.getElementById('copyEmbedBtn');

            // Info Modal
            const infoModal = document.getElementById('infoModal');

            // No AI Use Modal
            const noAiModal = document.getElementById('noAiModal');
            const noAiDoneBtn = document.getElementById('noAiDoneBtn');
            const noAiCancelBtn = document.getElementById('noAiCancelBtn');

            // Share/Download Modal Elements
            const downloadModal = document.getElementById('downloadModal');
            const copyUrlBtn = document.getElementById('copyUrlBtn');
            const downloadHTMLBtn = document.getElementById('downloadHTML');
            const downloadMarkdownBtn = document.getElementById('downloadMarkdown');
            const downloadTextBtn = document.getElementById('downloadText');
            const downloadPNGBtn = document.getElementById('downloadPNG');

            const isInIframe = window.self !== window.top;

            // ‚îÄ‚îÄ‚îÄ Derive AI usage level from useCases checkboxes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function getAiUsageFromUseCases() {
                if (document.querySelector('input[name="useCases"][value="prohibited"]:checked')) return 'prohibited';
                if (document.querySelector('input[name="useCases"][value="encouraged"]:checked')) return 'encouraged';
                return document.querySelectorAll('input[name="useCases"]:checked').length > 0 ? 'limited' : null;
            }

            // ‚îÄ‚îÄ‚îÄ Mutual exclusion: No AI Use / Open Use gray out the rest ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function handleUseCaseExclusivity(changed) {
                const isExclusive = (changed.value === 'prohibited' || changed.value === 'encouraged');
                if (changed.checked && isExclusive) {
                    document.querySelectorAll('input[name="useCases"]').forEach(cb => {
                        if (cb !== changed) {
                            cb.checked = false;
                            cb.closest('.option-card').classList.add('grayed-out');
                        }
                    });
                } else if (!changed.checked && isExclusive) {
                    document.querySelectorAll('input[name="useCases"]').forEach(cb => {
                        cb.closest('.option-card').classList.remove('grayed-out');
                    });
                } else {
                    // Regular option clicked ‚Äî clear any exclusive selection
                    ['prohibited','encouraged'].forEach(val => {
                        const cb = document.querySelector(`input[name="useCases"][value="${val}"]`);
                        if (cb && cb.checked) {
                            cb.checked = false;
                            document.querySelectorAll('input[name="useCases"]').forEach(c => c.closest('.option-card').classList.remove('grayed-out'));
                        }
                    });
                }
            }

            // ‚îÄ‚îÄ‚îÄ Mutual exclusion: No Disclosure Required grays out the rest ‚îÄ‚îÄ
            function handleDocumentationExclusivity(changed) {
                if (changed.value === 'none') {
                    if (changed.checked) {
                        document.querySelectorAll('input[name="documentation"]').forEach(cb => {
                            if (cb !== changed) { cb.checked = false; cb.closest('.option-card').classList.add('grayed-out'); }
                        });
                    } else {
                        document.querySelectorAll('input[name="documentation"]').forEach(cb => cb.closest('.option-card').classList.remove('grayed-out'));
                    }
                } else {
                    const noneCb = document.querySelector('input[name="documentation"][value="none"]');
                    if (noneCb && noneCb.checked) {
                        noneCb.checked = false;
                        document.querySelectorAll('input[name="documentation"]').forEach(cb => cb.closest('.option-card').classList.remove('grayed-out'));
                    }
                }
            }

            // ‚îÄ‚îÄ‚îÄ Hide documentation section when AI is prohibited ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function handleConditionalQuestions() {
                const aiUsage = getAiUsageFromUseCases();
                const docQ = document.getElementById('question4');
                if (aiUsage === 'prohibited') {
                    docQ.classList.add('hidden');
                    document.querySelectorAll('input[name="documentation"]').forEach(cb => {
                        cb.checked = false;
                        cb.closest('.option-card').classList.remove('grayed-out');
                    });
                } else {
                    docQ.classList.remove('hidden');
                }
                updateIframeHeight();
            }

            function toggleOtherUseCases() {
                const cb = document.querySelector('input[name="useCases"][value="other"]');
                document.getElementById('otherUseCasesContainer').classList.toggle('hidden', !(cb && cb.checked));
                updateIframeHeight();
            }

            function toggleOtherDocumentation() {
                const cb = document.querySelector('input[name="documentation"][value="other"]');
                otherDocumentationContainer.classList.toggle('hidden', !(cb && cb.checked));
                updateIframeHeight();
            }

            // ‚îÄ‚îÄ‚îÄ URL state encoding ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function encodeFormState() {
                const formData = new FormData(form);
                const state = {
                    u:   Array.from(formData.getAll('useCases')),
                    d:   Array.from(formData.getAll('documentation')),
                    cu:  document.getElementById('customUseCases')?.value || '',
                    cd:  document.getElementById('customDocumentation')?.value || '',
                    pr:  document.querySelector('input[name="prohibitionReason"]:checked')?.value || '',
                    prt: document.getElementById('prohibitionReasonText')?.value || ''
                };
                return btoa(JSON.stringify(state));
            }

            function decodeFormState(encoded) {
                try {
                    const state = JSON.parse(atob(encoded));
                    if (state.u) state.u.forEach(v => {
                        const cb = document.querySelector(`input[name="useCases"][value="${v}"]`);
                        if (cb) { cb.checked = true; handleUseCaseExclusivity(cb); }
                    });
                    if (state.d) state.d.forEach(v => {
                        const cb = document.querySelector(`input[name="documentation"][value="${v}"]`);
                        if (cb) { cb.checked = true; handleDocumentationExclusivity(cb); }
                    });
                    if (state.cu) { const el = document.getElementById('customUseCases'); if (el) el.value = state.cu; }
                    if (state.cd) { const el = document.getElementById('customDocumentation'); if (el) el.value = state.cd; }
                    if (state.pr) {
                        const r = document.querySelector(`input[name="prohibitionReason"][value="${state.pr}"]`);
                        if (r) r.checked = true;
                    }
                    if (state.prt) { const el = document.getElementById('prohibitionReasonText'); if (el) el.value = state.prt; }
                    handleConditionalQuestions();
                    toggleOtherUseCases();
                    toggleOtherDocumentation();
                    updatePolicyPreview();
                } catch(e) { console.debug('Invalid URL parameters:', e); }
            }

            function updateURL() {
                try {
                    const newURL = new URL(window.location.href);
                    newURL.searchParams.set('policy', encodeFormState());
                    window.history.replaceState({}, '', newURL);
                } catch(e) { console.error('Error updating URL:', e); }
            }

            function initializeFromURL() {
                try {
                    const encoded = new URLSearchParams(window.location.search).get('policy');
                    if (encoded) {
                        decodeFormState(encoded);
                        setTimeout(() => { updatePolicyPreview(); updateIframeHeight(); }, 0);
                    }
                } catch(e) { console.error('Error initializing from URL:', e); }
            }

            initializeFromURL();

            function updateIframeHeight() {
                if (isInIframe) window.parent.postMessage({ type: 'resize', height: document.documentElement.scrollHeight }, '*');
            }

            function sendPolicyUpdate() {
                if (isInIframe) {
                    const policyText = Array.from(previewContainer.querySelectorAll('.policy-section'))
                        .map(s => s.querySelector('p')?.textContent.trim() || '').join('\n\n');
                    window.parent.postMessage({ type: 'policyUpdate', policy: policyText }, '*');
                }
            }

            window.addEventListener('message', function(event) {
                if (event.data.type === 'getPolicy') {
                    const policyText = Array.from(previewContainer.querySelectorAll('.policy-section'))
                        .map(s => s.querySelector('p')?.textContent.trim() || '').join('\n\n');
                    event.source.postMessage({ type: 'policyResponse', policy: policyText }, event.origin);
                }
            });

            // ‚îÄ‚îÄ‚îÄ Text builders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function getDocumentationText() {
                const selected = Array.from(document.querySelectorAll('input[name="documentation"]:checked'))
                    .filter(cb => cb.value !== 'none')
                    .map(cb => {
                        if (cb.value === 'other') {
                            const t = document.getElementById('customDocumentation')?.value?.trim() || '';
                            return t ? { title: '', text: t, icon: '‚ûï' } : null;
                        }
                        if (cb.value === 'chatsummary') {
                            return { title: 'Submit Chat Summary', text: 'Submit a brief AI-generated summary of your chat conversation. Try: \u201cPlease summarize the chat we\u2019ve just had into 2 or 3 paragraphs.\u201d', icon: 'üí¨' };
                        }
                        const card = cb.closest('.option-card').querySelector('.card-content');
                        return {
                            title: card.querySelector('h3')?.textContent || '',
                            text: card.querySelector('p').textContent,
                            icon: card.querySelector('.icon')?.textContent || ''
                        };
                    })
                    .filter(Boolean);
                if (!selected.length) return '';
                return 'Please share how you used AI:\n' +
                    selected.map(i => {
                        if (i.title) {
                            return `<div class="use-case-header"><span class="icon">${i.icon}</span><h4 class="use-case-title">${i.title}: </h4></div><p class="use-case-text">${i.text}</p>`;
                        }
                        return `<span class="icon">${i.icon}</span> ${i.text}`;
                    }).join('\n');
            }

            function getUseCasesText() {
                const selected = Array.from(document.querySelectorAll('input[name="useCases"]:checked'))
                    .filter(cb => cb.value !== 'prohibited' && cb.value !== 'encouraged')
                    .map(cb => {
                        if (cb.value === 'other') {
                            const t = document.getElementById('customUseCases')?.value?.trim() || '';
                            return t ? { title: '', text: t, icon: '‚ûï' } : null;
                        }
                        const card = cb.closest('.option-card').querySelector('.card-content');
                        return {
                            title: card.querySelector('h3')?.textContent || '',
                            text: card.querySelector('p').textContent,
                            icon: card.querySelector('.icon')?.textContent || ''
                        };
                    })
                    .filter(Boolean);
                if (!selected.length) return '';
                return 'Feel free to leverage AI:\n' +
                    selected.map(i => {
                        if (i.title) {
                            return `<div class="use-case-header"><span class="icon">${i.icon}</span><h4 class="use-case-title">${i.title}: </h4></div><p class="use-case-text">${i.text}</p>`;
                        }
                        return `<span class="icon">${i.icon}</span> ${i.text}`;
                    }).join('\n');
            }

            function generatePolicyIcons() {
                const aiUsage = getAiUsageFromUseCases();
                const noneCb = document.querySelector('input[name="documentation"][value="none"]:checked');
                const hasDoc = !noneCb && document.querySelectorAll('input[name="documentation"]:checked').length > 0;
                const icons = [];
                if (aiUsage === 'encouraged') icons.push('<span class="policy-icon" aria-hidden="true" title="Open AI Use">‚úÖ</span>');
                else if (aiUsage === 'limited')    icons.push('<span class="policy-icon" aria-hidden="true" title="Selective AI Use">‚ö†Ô∏è</span>');
                else if (aiUsage === 'prohibited') icons.push('<span class="policy-icon" aria-hidden="true" title="No AI Use">üö´</span>');
                if (hasDoc) icons.push('<span class="policy-icon" aria-hidden="true" title="Documentation Required">üìù</span>');
                return icons.join('');
            }

            function generateAltText() {
                const parts = ['AI POLICY STATEMENT'];
                const headerEl = previewContainer.querySelector('.policy-header h2');
                if (headerEl) parts.push(headerEl.textContent.trim());
                previewContainer.querySelectorAll('.policy-section').forEach(s => {
                    const docSection = s.querySelector('.documentation-section');
                    if (docSection) {
                        const hdr = docSection.querySelector('.documentation-header');
                        if (hdr) parts.push(hdr.textContent.trim());
                        docSection.querySelectorAll('li').forEach(li => {
                            const t = li.textContent.replace(/\s+/g, ' ').trim();
                            if (t) parts.push(t);
                        });
                    } else {
                        const p = s.querySelector('p');
                        if (p) { const t = p.textContent.trim(); if (t) parts.push(t); }
                    }
                });
                const alt = parts.join('  |  ');
                altTextArea.value = alt;
                modalAltTextArea.value = alt;
            }

            // ‚îÄ‚îÄ‚îÄ Main preview builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function updatePolicyPreview() {
                const sections = [];
                const aiUsage = getAiUsageFromUseCases();
                const noneCb = document.querySelector('input[name="documentation"][value="none"]:checked');
                const hasDoc = !noneCb && document.querySelectorAll('input[name="documentation"]:checked').length > 0;

                // Header
                if (aiUsage) {
                    const labels = { encouraged: 'Open AI Use', limited: 'Selective AI Use', prohibited: 'No AI Use for This Assignment' };
                    let header = labels[aiUsage];
                    if (hasDoc) header += ' ‚Äî Documentation Required';
                    sections.push({ text: header, iconHTML: generatePolicyIcons(), isHeader: true });
                }

                // Body: usage detail
                if (aiUsage === 'encouraged') {
                    sections.push({ text: 'Learners are welcome to use AI tools in any way that supports their learning on this assignment.', iconHTML: '<span class="icon" aria-hidden="true">‚úÖ</span>' });
                } else if (aiUsage === 'prohibited') {
                    const reasonText = document.getElementById('prohibitionReasonText')?.value?.trim();
                    const reasonRadio = document.querySelector('input[name="prohibitionReason"]:checked');
                    const reason = reasonText || reasonRadio?.value || '';
                    const noAiBaseText = 'This assignment is designed to be completed without AI tools.';
                    const noAiText = reason ? `${noAiBaseText} ${reason}` : noAiBaseText;
                    sections.push({ text: noAiText, iconHTML: '<span class="icon" aria-hidden="true">üö´</span>' });
                } else if (aiUsage === 'limited') {
                    const text = getUseCasesText();
                    if (text) sections.push({ text, iconHTML: '<span class="icon" aria-hidden="true">‚úîÔ∏è</span>', isDocumentation: true });
                }

                // Documentation requirements
                if (aiUsage !== 'prohibited' && hasDoc) {
                    const text = getDocumentationText();
                    if (text) sections.push({ text, iconHTML: '<span class="icon" aria-hidden="true">üìù</span>', isDocumentation: true });
                }

                // Render HTML
                let html = '';
                sections.forEach(s => {
                    if (s.isHeader) {
                        const cls = { encouraged: 'policy-permitted', limited: 'policy-limited', prohibited: 'policy-prohibited' }[aiUsage] || '';
                        html += `<div class="policy-header ${cls}"><div class="policy-icons">${s.iconHTML}</div><h2>${s.text}</h2></div>`;
                    } else if (s.isDocumentation) {
                        const [h, ...reqs] = s.text.split('\n');
                        html += `<div class="policy-section">${s.iconHTML}<div class="documentation-section"><h3 class="documentation-header">${h}</h3><ul class="documentation-requirements policy-list">${reqs.filter(r=>r.trim()).map(r=>`<li>${r}</li>`).join('')}</ul></div></div>`;
                    } else {
                        html += `<div class="policy-section">${s.iconHTML}<p>${s.text}</p></div>`;
                    }
                });
                previewContainer.innerHTML = html || '<p>Select options to generate your policy statement.</p>';
                generateAltText();
                updateIframeHeight();
                sendPolicyUpdate();
            }

            // ‚îÄ‚îÄ‚îÄ Event listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            form.addEventListener('change', function(e) {
                if (e.target.name === 'useCases') {
                    handleUseCaseExclusivity(e.target);
                    handleConditionalQuestions();
                    toggleOtherUseCases();
                    // Open modal when "No AI Use" is checked
                    if (e.target.value === 'prohibited' && e.target.checked) {
                        noAiModal.classList.remove('hidden');
                        document.body.classList.add('modal-open');
                        return; // preview updates when Done is clicked
                    }
                } else if (e.target.name === 'documentation') {
                    handleDocumentationExclusivity(e.target);
                    toggleOtherDocumentation();
                }
                updatePolicyPreview();
                updateURL();
            });

            // Prohibition reason radio/textarea live in the modal (outside the form)
            noAiModal.addEventListener('change', function(e) {
                if (e.target.name === 'prohibitionReason') {
                    const ta = document.getElementById('prohibitionReasonText');
                    if (ta) ta.value = '';
                }
            });

            ['customUseCases', 'customDocumentation', 'prohibitionReasonText'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', function() {
                    if (id === 'prohibitionReasonText' && this.value.trim()) {
                        // Clear radio suggestion when typing custom text
                        document.querySelectorAll('input[name="prohibitionReason"]').forEach(r => r.checked = false);
                    }
                    updatePolicyPreview();
                    updateURL();
                });
            });

            // Alt text copy (main)
            copyAltBtn.addEventListener('click', function() {
                altTextArea.select(); altTextArea.setSelectionRange(0, 99999); document.execCommand('copy');
                const orig = copyAltBtn.innerHTML;
                copyAltBtn.innerHTML = '<span class="icon" aria-hidden="true">‚úì</span> Copied';
                setTimeout(() => { copyAltBtn.innerHTML = orig; }, 2000);
            });

            // Alt text copy (modal)
            modalCopyAltBtn.addEventListener('click', function() {
                modalAltTextArea.select(); modalAltTextArea.setSelectionRange(0, 99999); document.execCommand('copy');
                const orig = modalCopyAltBtn.innerHTML;
                modalCopyAltBtn.innerHTML = '<span class="icon" aria-hidden="true">‚úì</span> Copied';
                setTimeout(() => { modalCopyAltBtn.innerHTML = orig; }, 2000);
            });

            // ‚îÄ‚îÄ‚îÄ No AI Use modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function cancelNoAi() {
                const prohibCb = document.querySelector('input[name="useCases"][value="prohibited"]');
                if (prohibCb && prohibCb.checked) {
                    prohibCb.checked = false;
                    document.querySelectorAll('input[name="useCases"]').forEach(cb => cb.closest('.option-card').classList.remove('grayed-out'));
                }
                document.querySelectorAll('input[name="prohibitionReason"]').forEach(r => r.checked = false);
                const prt = document.getElementById('prohibitionReasonText');
                if (prt) prt.value = '';
                noAiModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
                handleConditionalQuestions();
                updatePolicyPreview();
                updateURL();
            }

            noAiDoneBtn.addEventListener('click', function() {
                noAiModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
                updatePolicyPreview();
                updateURL();
            });
            noAiCancelBtn.addEventListener('click', cancelNoAi);
            document.querySelectorAll('.no-ai-cancel').forEach(btn => btn.addEventListener('click', cancelNoAi));
            noAiModal.addEventListener('click', function(e) { if (e.target === noAiModal) cancelNoAi(); });

            // Start Over
            startOverBtn.addEventListener('click', function() {
                previewContainer.innerHTML = '<p>Select options to generate your policy statement.</p>';
                altTextArea.value = '';
                form.reset();
                // Also clear prohibition reason (lives outside the form now)
                document.querySelectorAll('input[name="prohibitionReason"]').forEach(r => r.checked = false);
                const prt = document.getElementById('prohibitionReasonText');
                if (prt) prt.value = '';
                // Restore grayed-out cards
                document.querySelectorAll('.option-card.grayed-out').forEach(c => c.classList.remove('grayed-out'));
                // Hide conditional containers
                if (otherDocumentationContainer) otherDocumentationContainer.classList.add('hidden');
                document.getElementById('otherUseCasesContainer').classList.add('hidden');
                // Close any open modals
                noAiModal.classList.add('hidden');
                infoModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
                // Restore question visibility
                document.getElementById('question4').classList.remove('hidden');
                document.getElementById('question5').classList.remove('hidden');
                // Clear URL params
                const newURL = new URL(window.location.href);
                newURL.searchParams.delete('policy');
                window.history.replaceState({}, '', newURL);
                setTimeout(() => { previewContainer.innerHTML = '<p>Select options to generate your policy statement.</p>'; altTextArea.value = ''; }, 0);
            });


            // Share button ‚Üí open Share & Download modal
            shareBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                try { downloadModal.classList.remove('hidden'); document.body.classList.add('modal-open'); }
                catch(err) { console.error('Failed to open share modal:', err); }
            });

            // Info button ‚Üí open Info modal
            infoBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                try { infoModal.classList.remove('hidden'); document.body.classList.add('modal-open'); }
                catch(err) { console.error('Failed to open info modal:', err); }
            });

            function extractPlainText() {
                const parts = [];
                const h = previewContainer.querySelector('.policy-header h2');
                if (h) { parts.push(h.textContent.trim()); parts.push(''); }
                previewContainer.querySelectorAll('.policy-section').forEach(s => {
                    if (s.querySelector('.documentation-section')) {
                        const hdr = s.querySelector('.documentation-header').textContent.trim();
                        const reqs = Array.from(s.querySelectorAll('li')).map(li => li.textContent.trim()).join('\n');
                        parts.push(`${hdr}\n${reqs}`);
                    } else {
                        const icon = s.querySelector('.icon')?.textContent || '';
                        const text = s.querySelector('p')?.textContent.trim() || '';
                        if (text) parts.push(`${icon} ${text}`);
                    }
                });
                return parts.join('\n\n');
            }

            // Copy URL (inside Share modal)
            copyUrlBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                const url = window.location.href;
                const h3 = copyUrlBtn.querySelector('h3');
                navigator.clipboard.writeText(url).then(() => {
                    const orig = h3.textContent; h3.textContent = 'Copied!';
                    setTimeout(() => { h3.textContent = orig; }, 2000);
                }).catch(() => {
                    const ta = document.createElement('textarea'); ta.value = url;
                    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                    const orig = h3.textContent; h3.textContent = 'Copied!';
                    setTimeout(() => { h3.textContent = orig; }, 2000);
                });
            });

            // Embed modal open
            embedBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                try {
                    const iframeHTML = `<iframe src="${window.location.origin}${window.location.pathname}?policy=${encodeFormState()}" width="100%" height="1000px" frameborder="0" style="border:none;"></iframe>`;
                    embedCode.textContent = iframeHTML;
                    embedModal.classList.remove('hidden'); document.body.classList.add('modal-open');
                } catch(err) { console.error('Failed to open embed modal:', err); }
            });

            // Close all standard modals via X button
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault(); e.stopPropagation();
                    embedModal.classList.add('hidden'); downloadModal.classList.add('hidden');
                    pngReminderModal.classList.add('hidden'); infoModal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                });
            });
            [embedModal, downloadModal, pngReminderModal, infoModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) { modal.classList.add('hidden'); document.body.classList.remove('modal-open'); }
                });
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (!noAiModal.classList.contains('hidden')) { cancelNoAi(); return; }
                    embedModal.classList.add('hidden'); downloadModal.classList.add('hidden');
                    pngReminderModal.classList.add('hidden'); infoModal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                }
            });

            // Copy embed code
            copyEmbedBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                try {
                    const range = document.createRange(); range.selectNodeContents(embedCode);
                    const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
                    document.execCommand('copy'); sel.removeAllRanges();
                    const orig = copyEmbedBtn.textContent;
                    copyEmbedBtn.textContent = 'Copied!';
                    setTimeout(() => { copyEmbedBtn.textContent = orig; }, 2000);
                } catch(err) { console.error('Copy failed:', err); }
            });

            // Download format listeners
            function bindDownload(btn, fn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault(); e.stopPropagation();
                    try { fn(); downloadModal.classList.add('hidden'); document.body.classList.remove('modal-open'); }
                    catch(err) { console.error('Download failed:', err); }
                });
            }
            bindDownload(downloadHTMLBtn, downloadHTML);
            bindDownload(downloadMarkdownBtn, downloadMarkdown);
            bindDownload(downloadTextBtn, downloadPlainText);

            downloadPNGBtn.addEventListener('click', function(e) {
                e.preventDefault(); e.stopPropagation();
                const orig = downloadPNGBtn.querySelector('h3').textContent;
                downloadPNGBtn.querySelector('h3').textContent = 'Generating Image‚Ä¶';
                document.body.style.cursor = 'wait';
                try {
                    html2canvas(previewContainer, { scale: 2, backgroundColor: '#ffffff', logging: false }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'ai_policy_statement.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        downloadPNGBtn.querySelector('h3').textContent = orig;
                        document.body.style.cursor = 'default';
                        downloadModal.classList.add('hidden');
                        pngReminderModal.classList.remove('hidden');
                    }).catch(err => {
                        console.error('PNG generation failed:', err);
                        downloadPNGBtn.querySelector('h3').textContent = 'Error Generating Image';
                        document.body.style.cursor = 'default';
                        setTimeout(() => { downloadPNGBtn.querySelector('h3').textContent = orig; }, 2000);
                    });
                } catch(err) { console.error('Download PNG failed:', err); document.body.style.cursor = 'default'; }
            });

            // ‚îÄ‚îÄ‚îÄ Download helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function downloadHTML() {
                const blob = new Blob([generateFormattedHTML()], { type: 'text/html' });
                const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'ai_policy_statement.html' });
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            }
            function downloadMarkdown() {
                const blob = new Blob([generateMarkdown()], { type: 'text/markdown' });
                const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'ai_policy_statement.md' });
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            }
            function downloadPlainText() {
                const blob = new Blob([extractPlainText()], { type: 'text/plain' });
                const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'ai_policy_statement.txt' });
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
            }

            function generateFormattedHTML() {
                const aiUsage = getAiUsageFromUseCases();
                const clsMap = { encouraged: 'policy-permitted', limited: 'policy-limited', prohibited: 'policy-prohibited' };
                const policyClass = clsMap[aiUsage] || '';
                const headerEl = previewContainer.querySelector('.policy-header h2');
                let sections = [];
                if (headerEl) {
                    sections.push(`<div class="policy-header ${policyClass}"><div class="policy-icons">${generatePolicyIcons()}</div><h2>${headerEl.textContent.trim()}</h2></div>`);
                }
                previewContainer.querySelectorAll('.policy-section').forEach(s => {
                    if (s.querySelector('.documentation-section')) {
                        const hdr = s.querySelector('.documentation-header').textContent.trim();
                        const reqs = Array.from(s.querySelectorAll('li')).map(li => {
                            const m = li.textContent.trim().match(/^([\p{Emoji}\p{Symbol}\p{P}]+)\s+/u);
                            const icon = m ? m[1] : ''; const text = m ? li.textContent.trim().slice(icon.length).trim() : li.textContent.trim();
                            return `<li><span class="icon">${icon}</span> ${text}</li>`;
                        }).join('');
                        const icon = s.querySelector('.icon')?.textContent || '';
                        sections.push(`<div class="policy-section"><span class="icon" aria-hidden="true">${icon}</span><div class="documentation-section"><h3 class="documentation-header">${hdr}</h3><ul class="documentation-requirements policy-list">${reqs}</ul></div></div>`);
                    } else {
                        const icon = s.querySelector('.icon')?.textContent || '';
                        const text = s.querySelector('p')?.textContent.trim() || '';
                        if (text) sections.push(`<div class="policy-section"><span class="icon" aria-hidden="true">${icon}</span><p>${text}</p></div>`);
                    }
                });
                return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AI Policy Statement</title><style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;margin:2rem auto;max-width:800px;color:#333}
h1{color:#0046ad;border-bottom:2px solid #0046ad;padding-bottom:.5rem;margin-bottom:2rem}
.policy-header{background:#f8f9fa;border-left:4px solid #0046ad;padding:1rem;margin-bottom:1.5rem;border-radius:4px}
.policy-header.policy-permitted{border-left-color:#58a618}.policy-header.policy-limited{border-left-color:#ffc107}.policy-header.policy-prohibited{border-left-color:#dc3545}
.policy-header h2{margin:0;font-size:1.5rem;color:#2c3e50;font-weight:600}
.policy-section{display:flex;align-items:flex-start;gap:.75rem;margin-bottom:1rem}
.policy-section .icon{font-size:1.5em;flex-shrink:0;margin-top:.25rem}
.policy-section p{margin:0;flex:1;font-size:.9rem}
.documentation-section{width:100%}.documentation-header{font-weight:bold;margin-bottom:.75rem;margin-top:0;font-size:1rem}
.policy-list{list-style:none;padding-left:0}.policy-list li{margin-bottom:.75rem;font-size:.9rem}
.use-case-header{display:flex;align-items:center;gap:.3em;margin-bottom:.2rem}.use-case-header .icon{margin-right:0;flex-shrink:0;font-size:1.2em}
.use-case-title{font-size:1rem;font-weight:bold;margin:0}.use-case-text{font-size:.9rem;margin:.1rem 0 0;color:#555}
.icon{font-size:1.5em;vertical-align:middle;margin-right:.5em}
@media print{.policy-header,.policy-section{break-inside:avoid}}
</style></head><body><h1>AI Policy Statement</h1><div class="policy-statement">${sections.join('\n')}</div></body></html>`;
            }

            function generateMarkdown() {
                const parts = [];
                const h = previewContainer.querySelector('.policy-header h2');
                if (h) parts.push(`# ${h.textContent.trim()}\n`);
                previewContainer.querySelectorAll('.policy-section').forEach(s => {
                    if (s.querySelector('.documentation-section')) {
                        const hdr = s.querySelector('.documentation-header').textContent.trim();
                        const icon = s.querySelector('.icon')?.textContent || '';
                        parts.push(`## ${icon} ${hdr}\n`);
                        parts.push(Array.from(s.querySelectorAll('li')).map(li => `- ${li.textContent.trim()}`).join('\n') + '\n');
                    } else {
                        const icon = s.querySelector('.icon')?.textContent || '';
                        const text = s.querySelector('p')?.textContent.trim() || '';
                        if (text) parts.push(`${icon} ${text}\n`);
                    }
                });
                return parts.join('\n');
            }

            // ‚îÄ‚îÄ‚îÄ Event delegation fallback (WordPress/Brightspace iframes) ‚îÄ‚îÄ‚îÄ‚îÄ
            document.addEventListener('click', function(e) {
                if (e.target.closest('#shareBtn')) {
                    e.preventDefault(); e.stopPropagation();
                    try { downloadModal.classList.remove('hidden'); document.body.classList.add('modal-open'); } catch(err) {}
                    return;
                }
                if (e.target.closest('#infoBtn')) {
                    e.preventDefault(); e.stopPropagation();
                    try { infoModal.classList.remove('hidden'); document.body.classList.add('modal-open'); } catch(err) {}
                    return;
                }
                if (e.target.closest('#noAiDoneBtn')) {
                    e.preventDefault(); e.stopPropagation();
                    try { noAiModal.classList.add('hidden'); document.body.classList.remove('modal-open'); updatePolicyPreview(); updateURL(); } catch(err) {}
                    return;
                }
                if (e.target.closest('.no-ai-cancel')) {
                    e.preventDefault(); e.stopPropagation();
                    try { cancelNoAi(); } catch(err) {}
                    return;
                }
                if (e.target.closest('#embedBtn')) {
                    e.preventDefault(); e.stopPropagation();
                    try {
                        const iframeHTML = `<iframe src="${window.location.origin}${window.location.pathname}?policy=${encodeFormState()}" width="100%" height="1000px" frameborder="0" style="border:none;"></iframe>`;
                        embedCode.textContent = iframeHTML;
                        embedModal.classList.remove('hidden'); document.body.classList.add('modal-open');
                    } catch(err) {}
                    return;
                }
                if (e.target.closest('.close-modal')) {
                    e.preventDefault(); e.stopPropagation();
                    embedModal.classList.add('hidden'); downloadModal.classList.add('hidden');
                    pngReminderModal.classList.add('hidden'); infoModal.classList.add('hidden');
                    document.body.classList.remove('modal-open'); return;
                }
                if (e.target.closest('#copyUrlBtn')) {
                    e.preventDefault(); e.stopPropagation();
                    try {
                        const url = window.location.href;
                        const h3 = document.querySelector('#copyUrlBtn h3');
                        navigator.clipboard.writeText(url).then(() => {
                            const orig = h3.textContent; h3.textContent = 'Copied!';
                            setTimeout(() => { h3.textContent = orig; }, 2000);
                        }).catch(() => {
                            const ta = document.createElement('textarea'); ta.value = url;
                            document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                            const orig = h3.textContent; h3.textContent = 'Copied!';
                            setTimeout(() => { h3.textContent = orig; }, 2000);
                        });
                    } catch(err) {}
                    return;
                }
                if (e.target.closest('#downloadHTML'))     { e.preventDefault(); e.stopPropagation(); try { downloadHTML(); downloadModal.classList.add('hidden'); document.body.classList.remove('modal-open'); } catch(err) {} return; }
                if (e.target.closest('#downloadMarkdown')) { e.preventDefault(); e.stopPropagation(); try { downloadMarkdown(); downloadModal.classList.add('hidden'); document.body.classList.remove('modal-open'); } catch(err) {} return; }
                if (e.target.closest('#downloadText'))     { e.preventDefault(); e.stopPropagation(); try { downloadPlainText(); downloadModal.classList.add('hidden'); document.body.classList.remove('modal-open'); } catch(err) {} return; }
                if (e.target.closest('#copyEmbedBtn')) {
                    e.preventDefault(); e.stopPropagation();
                    try {
                        const range = document.createRange(); range.selectNodeContents(embedCode);
                        const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
                        document.execCommand('copy'); sel.removeAllRanges();
                        const orig = copyEmbedBtn.textContent; copyEmbedBtn.textContent = 'Copied!';
                        setTimeout(() => { copyEmbedBtn.textContent = orig; }, 2000);
                    } catch(err) {}
                    return;
                }
            });

        });
        /* --- MERGED JS END --- */
    </script>

</body>
</html>
